<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TF-IDF Vectorizer Visualization</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .card {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: none;
        }
        .card-header {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .table-hover tbody tr:hover {
            background-color: rgba(0,123,255,0.1);
        }
        .badge-tfidf {
            background-color: #17a2b8;
        }
        .badge-similarity {
            background-color: #28a745;
        }
        .badge-price {
            background-color: #ffc107;
            color: #000;
        }
        .badge-final {
            background-color: #dc3545;
            color: white;
        }
        .term-score {
            font-family: monospace;
            font-size: 0.85em;
        }
        .term-badge {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .term-badge:hover {
            transform: scale(1.05);
        }
        .modal-term-table td {
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .tab-content {
            padding: 15px;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }
        .nav-tabs .nav-link.active {
            background-color: #fff;
            border-bottom-color: #fff;
        }
        .target-row {
            background-color: #fff3cd !important;
            font-weight: bold;
        }
        .progress-perfect {
            background-color: #198754 !important;
        }
        .loading {
            text-align: center;
            padding: 50px;
        }
        .ranking-1 {
            background-color: #d1ecf1 !important;
        }
        .ranking-2 {
            background-color: #f8d7da !important;
        }
        .ranking-3 {
            background-color: #d4edda !important;
        }
        .rank-badge {
            font-size: 0.8em;
            padding: 2px 6px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header">
            <h1>üìä TF-IDF Vectorizer Visualization</h1>
            <p class="lead">Visualisasi vektor TF-IDF dan perhitungan similarity untuk sistem rekomendasi penginapan</p>
            <div class="row mt-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <input type="number" id="penginapanId" class="form-control" placeholder="Masukkan ID Penginapan" value="1">
                        <button class="btn btn-light" onclick="loadVectorizer()">Tampilkan Vektor</button>
                        <button class="btn btn-outline-light" onclick="loadTermScores()">Lihat Scores per Kata</button>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="alert alert-light">
                        <small>Weight: Content (10%) + Price (90%) | Database: tugas_akhir</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memproses data TF-IDF...</p>
        </div>

        <!-- Main Content -->
        <div id="content" style="display: none;">
            <!-- Target Penginapan Info -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üéØ Target Penginapan</h5>
                </div>
                <div class="card-body" id="targetInfo"></div>
            </div>

            <!-- TF-IDF Vector -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üìà TF-IDF Vector (50 Terms Teratas)</h5>
                    <span class="badge bg-primary" id="vocabSize"></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="vectorTable">
                            <thead>
                                <tr>
                                    <th width="10%">Rank</th>
                                    <th width="25%">Term (Kata)</th>
                                    <th width="15%">TF-IDF Value</th>
                                    <th width="15%">Index</th>
                                    <th width="35%">Visualisasi</th>
                                </tr>
                            </thead>
                            <tbody id="vectorBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- All Penginapan Comparison -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä Ranking Penginapan Berdasarkan Similarity dengan Target</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>Info Ranking:</strong> 
                        <span class="badge bg-warning text-dark">üèÜ Target (Rank 1)</span> | 
                        <span class="badge bg-danger">ü•à Rank 2</span> | 
                        <span class="badge bg-success">ü•â Rank 3</span> | 
                        <span class="badge bg-primary">Rank 4+</span>
                    </div>
                    <ul class="nav nav-tabs" id="comparisonTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab">Summary Ranking</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">TF-IDF Scores Detail</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="comparisonTabContent">
                        <!-- Tab 1: Summary -->
                        <div class="tab-pane fade show active" id="summary" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover" id="comparisonTable">
                                    <thead>
                                        <tr>
                                            <th>Rank</th>
                                            <th>ID</th>
                                            <th>Nama Penginapan</th>
                                            <th>Cosine Similarity</th>
                                            <th>Price Score</th>
                                            <th>Final Score</th>
                                            <th>Top Terms (TF-IDF Scores)</th>
                                            <th>Total Terms</th>
                                        </tr>
                                    </thead>
                                    <tbody id="comparisonBody"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Tab 2: TF-IDF Scores Detail -->
                        <div class="tab-pane fade" id="details" role="tabpanel">
                            <div class="mb-3">
                                <input type="text" id="termSearch" class="form-control" placeholder="Cari kata...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="termScoresTable">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Nama Penginapan</th>
                                            <th>Term Scores (Kata: Score)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="termScoresBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Parameters Info -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">‚öôÔ∏è TF-IDF Parameters</h6>
                        </div>
                        <div class="card-body" id="tfidfParams"></div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">üí∞ Price Parameters</h6>
                        </div>
                        <div class="card-body" id="priceParams"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal untuk Detail Term Scores -->
    <div class="modal fade" id="termDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">TF-IDF Scores untuk: <span id="modalTermName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table modal-term-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Penginapan</th>
                                <th>TF-IDF Score</th>
                                <th>Visualisasi</th>
                            </tr>
                        </thead>
                        <tbody id="modalTermBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.bootstrap5.min.js"></script>
    <script>
        let currentData = null;
        let termScoresTable = null;

        function loadVectorizer() {
            const penginapanId = document.getElementById('penginapanId').value;
            if (!penginapanId) {
                alert('Masukkan ID Penginapan terlebih dahulu!');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';

            fetch(`/vectorizer/${penginapanId}`)
                .then(response => response.json())
                .then(data => {
                    currentData = data;
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                    
                    displayTargetInfo(data.target_penginapan);
                    displayVectorTable(data.target_vector);
                    displayComparisonTable(data.all_penginapan);
                    displayTermScoresTable(data.all_penginapan);
                    displayParameters(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loading').style.display = 'none';
                    alert('Error loading data. Check console for details.');
                });
        }

        function loadTermScores() {
            const penginapanId = document.getElementById('penginapanId').value;
            if (!penginapanId) {
                alert('Masukkan ID Penginapan terlebih dahulu!');
                return;
            }

            fetch(`/term_scores/${penginapanId}`)
                .then(response => response.json())
                .then(data => {
                    showTermScoresModal(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading term scores.');
                });
        }

        function displayTargetInfo(target) {
            const targetInfo = document.getElementById('targetInfo');
            targetInfo.innerHTML = `
                <div class="row">
                    <div class="col-md-3">
                        <strong>ID:</strong> ${target.id}<br>
                        <strong>Nama:</strong> ${target.nama_penginapan}<br>
                        <strong>Harga:</strong> Rp ${target.harga.toLocaleString('id-ID')}<br>
                        <strong>Rating:</strong> ${target.rating}
                    </div>
                    <div class="col-md-4">
                        <strong>Fasilitas:</strong><br>
                        <small>${target.fasilitas || '-'}</small><br><br>
                        <strong>Deskripsi:</strong><br>
                        <small>${target.deskripsi || '-'}</small>
                    </div>
                    <div class="col-md-5">
                        <strong>Combined Text (Preprocessed):</strong><br>
                        <small class="text-muted">${target.combined_text || '-'}</small>
                    </div>
                </div>
            `;
        }

        function displayVectorTable(vectorData) {
            const vectorBody = document.getElementById('vectorBody');
            vectorBody.innerHTML = '';
            
            vectorData.forEach((item, index) => {
                const widthPercent = Math.min(item.tfidf_value * 150, 100);
                const rankBadge = getRankBadge(index + 1);
                
                const row = `
                    <tr>
                        <td>
                            ${rankBadge}
                            <strong>${index + 1}</strong>
                        </td>
                        <td>
                            <span class="badge bg-dark term-badge" onclick="showTermDetail('${item.term}')">
                                ${item.term}
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-tfidf term-score">${item.tfidf_value.toFixed(6)}</span>
                        </td>
                        <td>${item.feature_index}</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar bg-info" role="progressbar" 
                                     style="width: ${widthPercent}%" 
                                     title="${item.tfidf_value.toFixed(6)}">
                                    ${(item.tfidf_value * 100).toFixed(2)}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                vectorBody.innerHTML += row;
            });

            if ($.fn.DataTable.isDataTable('#vectorTable')) {
                $('#vectorTable').DataTable().destroy();
            }
            $('#vectorTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[0, 'asc']]
            });
        }

        function getRankBadge(rank) {
            if (rank === 1) return '<span class="badge bg-warning text-dark rank-badge">üèÜ</span>';
            if (rank === 2) return '<span class="badge bg-danger rank-badge">ü•à</span>';
            if (rank === 3) return '<span class="badge bg-success rank-badge">ü•â</span>';
            return `<span class="badge bg-primary rank-badge">${rank}</span>`;
        }

        function displayComparisonTable(allData) {
            const comparisonBody = document.getElementById('comparisonBody');
            comparisonBody.innerHTML = '';
            
            const targetId = parseInt(document.getElementById('penginapanId').value);
            
            // Urutkan berdasarkan final score tertinggi (descending)
            const sortedData = [...allData].sort((a, b) => b.final_score - a.final_score);
            
            sortedData.forEach((item, index) => {
                const topTerms = item.top_terms.map(term => 
                    `<span class="badge bg-light text-dark m-1 term-badge" 
                          onclick="showTermDetail('${term.term}')"
                          title="TF-IDF: ${term.value}">
                        ${term.term}: ${term.value.toFixed(4)}
                    </span>`
                ).join('');
                
                const finalScorePercent = (item.final_score * 100).toFixed(1);
                const isTarget = item.id === targetId;
                const rank = index + 1;
                const rankBadge = getRankBadge(rank);
                const rowClass = isTarget ? 'target-row' : getRankingClass(rank);
                
                const row = `
                    <tr class="${rowClass}">
                        <td>
                            ${rankBadge}
                            <strong>${rank}</strong>
                            ${isTarget ? '<span class="badge bg-warning text-dark ms-1">TARGET</span>' : ''}
                        </td>
                        <td>${item.id}</td>
                        <td>
                            <strong>${item.nama_penginapan}</strong>
                        </td>
                        <td>
                            <span class="badge badge-similarity" title="Cosine Similarity">${item.cosine_similarity.toFixed(4)}</span><br>
                            <small>${(item.cosine_similarity * 100).toFixed(1)}%</small>
                        </td>
                        <td>
                            <span class="badge badge-price" title="Price Score">${item.price_score.toFixed(4)}</span><br>
                            <small>${(item.price_score * 100).toFixed(1)}%</small>
                        </td>
                        <td>
                            <div class="progress" style="height: 15px;">
                                <div class="progress-bar ${isTarget ? 'progress-perfect' : 'bg-success'}" role="progressbar" 
                                     style="width: ${finalScorePercent}%" 
                                     title="${item.final_score.toFixed(4)}">
                                    ${finalScorePercent}%
                                </div>
                            </div>
                            <small>
                                <strong>${item.final_score.toFixed(4)}</strong>
                            </small>
                        </td>
                        <td>${topTerms}</td>
                        <td><span class="badge bg-dark">${item.total_terms}</span></td>
                    </tr>
                `;
                comparisonBody.innerHTML += row;
            });

            if ($.fn.DataTable.isDataTable('#comparisonTable')) {
                $('#comparisonTable').DataTable().destroy();
            }
            $('#comparisonTable').DataTable({
                pageLength: 10,
                lengthMenu: [10, 25, 50, 100],
                order: [[0, 'asc']],
                columnDefs: [
                    { targets: 6, width: "30%" }
                ]
            });
        }

        function getRankingClass(rank) {
            if (rank === 1) return 'ranking-1';
            if (rank === 2) return 'ranking-2';
            if (rank === 3) return 'ranking-3';
            return '';
        }

        function displayTermScoresTable(allData) {
            const termScoresBody = document.getElementById('termScoresBody');
            termScoresBody.innerHTML = '';
            
            const targetId = parseInt(document.getElementById('penginapanId').value);
            
            allData.forEach(item => {
                const termScores = Object.entries(item.all_term_scores || {})
                    .sort((a, b) => b[1] - a[1])
                    .map(([term, score]) => 
                        `<span class="badge bg-light text-dark m-1 term-badge" 
                              onclick="showTermDetail('${term}')"
                              title="${term}: ${score}">
                            ${term}: <strong>${score.toFixed(4)}</strong>
                        </span>`
                    )
                    .join('');
                
                const row = `
                    <tr ${item.id === targetId ? 'class="target-row"' : ''}>
                        <td>${item.id}</td>
                        <td><strong>${item.nama_penginapan}</strong></td>
                        <td>${termScores || '<em>No terms</em>'}</td>
                    </tr>
                `;
                termScoresBody.innerHTML += row;
            });

            if (termScoresTable) {
                termScoresTable.destroy();
            }
            
            termScoresTable = $('#termScoresTable').DataTable({
                pageLength: 5,
                lengthMenu: [5, 10, 25, 50],
                order: [[0, 'asc']],
                columnDefs: [
                    { targets: 2, width: "60%" }
                ]
            });

            $('#termSearch').on('keyup', function() {
                termScoresTable.search(this.value).draw();
            });
        }

        function showTermDetail(term) {
            if (!currentData) return;
            
            const modalTermName = document.getElementById('modalTermName');
            const modalTermBody = document.getElementById('modalTermBody');
            
            modalTermName.textContent = term;
            modalTermBody.innerHTML = '';
            
            const termDetails = [];
            currentData.all_penginapan.forEach(p => {
                if (p.all_term_scores && p.all_term_scores[term]) {
                    termDetails.push({
                        id: p.id,
                        name: p.nama_penginapan,
                        score: p.all_term_scores[term],
                        isTarget: p.id === parseInt(document.getElementById('penginapanId').value)
                    });
                }
            });
            
            termDetails.sort((a, b) => b.score - a.score);
            
            termDetails.forEach((detail, index) => {
                const widthPercent = Math.min(detail.score * 150, 100);
                const row = `
                    <tr ${detail.isTarget ? 'class="table-warning"' : ''}>
                        <td>${index + 1}</td>
                        <td>
                            <strong>${detail.name}</strong><br>
                            <small>ID: ${detail.id} ${detail.isTarget ? '(TARGET)' : ''}</small>
                        </td>
                        <td>
                            <span class="badge bg-info">${detail.score.toFixed(6)}</span>
                        </td>
                        <td>
                            <div class="progress" style="height: 10px;">
                                <div class="progress-bar ${detail.isTarget ? 'bg-warning' : 'bg-success'}" role="progressbar" 
                                     style="width: ${widthPercent}%" 
                                     title="${detail.score.toFixed(6)}">
                                </div>
                            </div>
                            <small>${(detail.score * 100).toFixed(2)}%</small>
                        </td>
                    </tr>
                `;
                modalTermBody.innerHTML += row;
            });
            
            if (termDetails.length === 0) {
                modalTermBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center">
                            <em>Term "${term}" tidak ditemukan di penginapan manapun</em>
                        </td>
                    </tr>
                `;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('termDetailModal'));
            modal.show();
        }

        function showTermScoresModal(data) {
            const modalHtml = `
                <div class="modal fade" id="allTermsModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">TF-IDF Scores untuk Semua Kata</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Total Terms:</strong> ${data.total_terms} | <strong>Total Documents:</strong> ${data.total_documents}</p>
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Term</th>
                                                <th>Jumlah Dokumen</th>
                                                <th>Top Scores</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${Object.entries(data.terms).map(([term, scores]) => `
                                                <tr>
                                                    <td><strong>${term}</strong></td>
                                                    <td><span class="badge bg-secondary">${scores.length}</span></td>
                                                    <td>
                                                        ${scores.slice(0, 3).map(s => 
                                                            `<span class="badge bg-info m-1">${s.penginapan_name}: ${s.score}</span>`
                                                        ).join('')}
                                                        ${scores.length > 3 ? `<span class="badge bg-light text-dark">+${scores.length - 3} more</span>` : ''}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            const modal = new bootstrap.Modal(document.getElementById('allTermsModal'));
            modal.show();
            
            document.getElementById('allTermsModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function displayParameters(data) {
            document.getElementById('tfidfParams').innerHTML = `
                <p><strong>Vocabulary Size:</strong> ${data.tfidf_params.vocabulary_size} terms</p>
                <p><strong>Jumlah Dokumen:</strong> ${data.tfidf_params.num_documents} penginapan</p>
                <p><strong>Stopwords:</strong> ${data.tfidf_params.stopwords_used} kata</p>
                <p><strong>Weight Configuration:</strong> ${data.tfidf_params.weight_config}</p>
                <p><small class="text-muted">Final Score = (${data.tfidf_params.weight_config.split('=')[1].split(',')[0]} √ó Cosine Similarity) + (${data.tfidf_params.weight_config.split('=')[2]} √ó Price Score)</small></p>
            `;

            document.getElementById('vocabSize').textContent = `${data.tfidf_params.vocabulary_size} terms`;
            document.getElementById('priceParams').innerHTML = `
                <p><strong>Target Price:</strong> Rp ${data.price_params.target_price.toLocaleString('id-ID')}</p>
                <p><strong>Min Price:</strong> Rp ${data.price_params.min_price.toLocaleString('id-ID')}</p>
                <p><strong>Max Price:</strong> Rp ${data.price_params.max_price.toLocaleString('id-ID')}</p>
                <p><strong>Price Range:</strong> Rp ${data.price_params.price_range.toLocaleString('id-ID')}</p>
                <p><small class="text-muted">Price Score = 1 - (|harga - target_harga| / range)</small></p>
            `;
        }

        // Load data untuk ID 1 saat halaman pertama kali dibuka
        document.addEventListener('DOMContentLoaded', function() {
            loadVectorizer();
        });
    </script>
</body>
</html>